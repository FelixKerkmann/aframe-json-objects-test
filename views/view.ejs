<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="../public/components/input-listen.js"></script>
    <script src="/public/components/selectable.js"></script>
    <script src="/public/components/objectSelectorController.js"></script>
    <link rel="stylesheet" type="text/css" href="../public/css/style.css">
</head>
<body onload="initialiseObjectSelection()">

<!-- Scene view -->
<div id="sceneView" class="wide" >
    <a-scene>
        <a-assets>
            <img id="hall" src="../public/resources/skyboxes/hall.jpg">
            <img id="architecture" src="../public/resources/skyboxes/architecture.jpg">
            <img id="room-parkett" src="../public/resources/skyboxes/room_parkett.jpg">
            <img id="room-white-wood" src="../public/resources/skyboxes/room_white_wood.jpg">
            <img id="track" src="../public/resources/skyboxes/track.jpg">
            <img id="alaskaSkybox" src="../public/resources/skyboxes/alaska.jpg">
            <img id="lakeSkybox" src="../public/resources/skyboxes/lake.jpeg">
            <img id="citySkybox" src="../public/resources/skyboxes/citySkybox.jpg">
        </a-assets>

        <a-sky id="skybox" src="#alaskaSkybox"></a-sky>

        <a-entity id="cameraRig">
            <a-entity id="player"
                      camera
                      wasd-controls
                      look-controls
                      position="0 1.6 0"
                      networked="template:#avatar-template;attachTemplateToLocal:false;" random-color>
                <a-sphere class="head"
                          visible="false"
                          random-color
                ></a-sphere>
                <a-cursor></a-cursor>
            </a-entity>
            <a-entity id="ctlL"
                      teleport-controls="cameraRig: #cameraRig; teleportOrigin: #player; startEvents: teleportstart; endEvents: teleportend"
                      oculus-touch-controls="hand: left"
                      input-listen>
                <a-text value="X: Teleport"
                        position="0 0.08 0"
                        rotation="-90 0 0"
                        scale="0.1 0.1 0.1"
                        align="center"
                        color="#FFFFFF"></a-text>
                <a-sphere radius="0.01"
                          position="0 0 -1.2"
                          color="#FFFFFF"></a-sphere>
            </a-entity>
            <a-entity id="ctlR"
                      teleport-controls="cameraRig: #cameraRig; teleportOrigin: #player; startEvents: teleportstart; endEvents: teleportend"
                      oculus-touch-controls="hand: right"
                      input-listen>
                <a-text value="A: Teleport"
                        position="0 0.08 0"
                        rotation="-90 0 0"
                        scale="0.1 0.1 0.1"
                        align="center"
                        color="#FFFFFF"></a-text>
                <a-sphere radius="0.01"
                          position="0 0 -1.2"
                          color="#FFFFFF"></a-sphere>
            </a-entity>
        </a-entity>

        <a-entity id="ObjectSelector"
                  objectselector>
        </a-entity>

        <a-entity gltf-model="url(/public/resources/uploads/rooms/DemoRaumDiffuseOnlyCompressed.glb)"
                  position="0 0 0"
                  rotation="0 0 0"
                  scale="1 1 1">
        </a-entity>

        <%- entities %>
    </a-scene>
</div>

<!-- Right panel -->
<div id="rightPanel" class="disabled">
    <p id="objectName" class="attributeTitle">Kein Objekt ausgewählt</p>

    <p class="attributeTitle">Position</p>
    <label for="positionX">X</label>
    <input class="inputNumber" type="number" id="positionX" name="positionX"
           onfocusin="storeOldValue(this.id)"
           onchange="emitOnValueChange(this.id)"
           onfocusout="emitOnValueSubmit(this.id)">
    <label for="positionY">Y</label>
    <input class="inputNumber" type="number" id="positionY" name="positionY"
           onfocusin="storeOldValue(this.id)"
           onchange="emitOnValueChange(this.id)"
           onfocusout="emitOnValueSubmit(this.id)">
    <label for="positionZ">Z</label>
    <input class="inputNumber" type="number" id="positionZ" name="positionZ"
           onfocusin="storeOldValue(this.id)"
           onchange="emitOnValueChange(this.id)"
           onfocusout="emitOnValueSubmit(this.id)">

    <p class="attributeTitle">Rotation</p>
    <label for="rotationX">X</label>
    <input class="inputNumber" type="number" id="rotationX" name="rotationX"
           onfocusin="storeOldValue(this.id)"
           onchange="emitOnValueChange(this.id)"
           onfocusout="emitOnValueSubmit(this.id)">
    <label for="rotationY">Y</label>
    <input class="inputNumber" type="number" id="rotationY" name="rotationY"
           onfocusin="storeOldValue(this.id)"
           onchange="emitOnValueChange(this.id)"
           onfocusout="emitOnValueSubmit(this.id)">
    <label for="rotationZ">Z</label>
    <input class="inputNumber" type="number" id="rotationZ" name="rotationZ"
           onfocusin="storeOldValue(this.id)"
           onchange="emitOnValueChange(this.id)"
           onfocusout="emitOnValueSubmit(this.id)">
    <p class="attributeTitle">Scale</p>
    <label for="scale">X, Y, Z</label>
    <input class="inputNumber" type="number" id="scale" name="scale"
           onfocusin="storeOldValue(this.id)"
           onchange="emitOnValueChange(this.id)"
           onfocusout="emitOnValueSubmit(this.id)">
</div>


<script>
    const NO_ELEMENT_SELECTED = "Kein Objekt ausgewählt";

    let objectSelector;
    let oldValue;

    function initialiseObjectSelection(){
        objectSelector = document.querySelector('#ObjectSelector');

        // It has to the "keyup" event because "keydown" doesn't register some keys like escape
        window.addEventListener("keyup", function (event) {
            if (event.key === 'Escape') {
                document.querySelector('#ObjectSelector').emit('changeSelection',
                    {
                        selectedObject: null
                    });
            }
        });
    }

    function storeOldValue(key){
        // TODO: Remove? Is it still possible to call this function while no item is selected?
        if(noItemSelected()){
            console.warn("Ignoring storeOldValue with key " + key + ", because there is no element selected.")
            return;
        }
        oldValue = document.getElementById(key).value;
    }

    function emitOnValueChange(key) {
        const newValue       = document.getElementById(key).value;
        // TODO: Remove? Is it still possible to call this function while no item is selected?
        if(noItemSelected()){
            console.warn("Ignoring onValueChange with key " + key + ", because there is no element selected.");
            return;
        }

        console.log("Fire \"onValueChange\" with key: " + key + ", old value: " + oldValue + ", new value: " + newValue);

        objectSelector.emit("onValueChange",
            {
                'key': key,
                'oldValue': oldValue,
                'newValue': newValue
            });
    }

    function emitOnValueSubmit(key) {
        const newValue       = document.getElementById(key).value;

        // TODO: Remove? Is it still possible to call this function while no item is selected?
        if(noItemSelected()){
            console.warn("Ignoring onValueSubmit with key " + key + ", because there is no element selected.");
            return;
        }

        if(oldValue === newValue){
            console.warn("Ignoring onValueChange with key " + key + ", because value did not change.");
            return;
        }

        console.log("Fire \"onValueSubmit\" with key: " + key + ", old value: " + oldValue + ", new value: " + newValue);

        objectSelector.emit("onValueSubmit",
            {
                'key': key,
                'oldValue': oldValue,
                'newValue': newValue
            });

        oldValue = null;
    }

    function noItemSelected(){
        return document.getElementById("objectName").textContent === NO_ELEMENT_SELECTED;
    }
</script>

</body>
</html>

